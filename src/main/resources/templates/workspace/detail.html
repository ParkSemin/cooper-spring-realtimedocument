<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooper</title>
    <link rel="stylesheet" type="text/css" th:href="@{/style.css}">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<body>
	<div class=container style="width: 800px">
		<div class=content>
			<form id="out-form" action="/workspace/list" method="post">
			    <input type="hidden" name="id" th:value=${user.id}>
			    <input type="hidden" name="name" th:value=${user.name}>
			    <button type="submit" id="leave-button" onclick="quit()">돌아가기</button>
			</form>
			<form id="out-form" action="/workspace/list" method="post">
			    <input type="hidden" name="id" th:value=${user.id}>
			    <input type="hidden" name="name" th:value=${user.name}>
			    <button type="submit" id="leave-button" onclick="out()">워크스페이스 나가기</button>
			</form>
			<h1 th:text="${workspace.name}"></h1>
			<h3 th:text="|생성자 : ${workspace.generator.name}|"></h3>
			<h5>Workspace Members :</h5>

			<!-- <div th:each="member : ${workspace.member}" style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
				<div th:id="${member.id}" class="circle"></div>
			    <p th:text="${member.name}" style="margin: 0;"></p>
			</div> -->
			<div id="members" style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;"></div>
            <textarea id="log-area" style="
			    width: 500px;
			    height: 300px;
			"></textarea>
		</div>
	</div>
	
	<script th:inline="javascript"> 
		var workspaceName = [[${workspace.name}]];
		var user = [[${user}]];
		var totalMembers;
		var onlineMembers;
		
		var sockJs = new SockJS("/ws/workspace");
		var stomp = Stomp.over(sockJs);
		
		var workspaceLog = "";
		stomp.connect({}, function() {			
			// 구독
			stomp.subscribe("/sub/workspace/" + workspaceName, function (frame) {
				// TO DO
				var content = JSON.parse(frame.body);
				totalMembers = content.totalMembers;
				onlineMembers = content.onlineMembers;
				
				var now = new Date();
	            var date = now.toLocaleDateString(); // 현재 날짜를 가져옵니다.
	            var time = now.toLocaleTimeString(); // 현재 시간을 가져옵니다.
	            
				workspaceLog += "[" + date + " " + time + "] - " + content.message;
				
				// textarea 설정
				$("#log-area").val(workspaceLog);
				checkOnlineMember();
			});
			
			
			stomp.send("/pub/workspace/enter", {}, JSON.stringify({workspaceName: workspaceName, user: user}));
		});
		
		// '돌아가기' 버튼 누르면 실행되는 메서드
		function quit() {
			var ws = stomp.ws;
			stomp.send("/pub/workspace/quit", {}, JSON.stringify({workspaceName: workspaceName, user: user}));
			ws.close();
		}
		
		// '워크스페이스 나가기' 버튼 누르면 실행되는 메서드
		function out() {
			var ws = stomp.ws;
			stomp.send("/pub/workspace/out", {}, JSON.stringify({workspaceName: workspaceName, user: user}));
			ws.close();
		}
		
		
		// 현재 접속중인 유저는 초록색, 아닌 유저는 빨간색으로 표시하는 메소드
		function checkOnlineMember() {
			/* onlineMembers.forEach((memberId) => {
				$("#"+memberId).css("background-color", "lime");
			});
			
			if (outMember) {
				$("#"+memberId).css("background-color", "red");
			} */
			var membersHTML = '';
			totalMembers.forEach((member) => {
				var backgroundColor = onlineMembers.includes(member.id) ? 'lime' : 'red';
				console.log(backgroundColor);
				membersHTML += 
					'<div id="' + member.id + '" class="circle" style="background-color: ' + backgroundColor + ';"></div>' +
	                '<p th:text="${member.name}" style="margin: 0;">' + member.name + '</p>';
	        });
	        document.getElementById('members').innerHTML = membersHTML;
		}
	</script>
</body>

</html>